var test=null,regexLib={normal:/^[a-z][a-z_0-9]*\s{0,1}(.*)$/m,fixed:/^[0-9]+\s{0,1}(.*)$/m,ignored:/^[A-Z].*$/m,link:/\[([^\[\]]+)\](?!\(|\:|{)/gm,div:/^(\:{3,}).*/m},parseText=function(t){t=t.split(/\n|\r\n/);return{yml:extractYAML(t),blocks:extractBlocks(t)}},extractYAML=function(t){for(var e,n,i,l=[],s="",a=!0,o=!1,r=0,h=t.length;r<h;r++)i=t[r],a&&!o?i.startsWith("---")?o=!(a=!1):a=!1:!a&&o&&(i.startsWith("---")?o=a=!1:l.push(i));for(e=0,n=l.length;e<n;e++)s+=l[e]+"\n";return s},getBlockType=function(t){return null!=t.match(regexLib.normal)?"normal":null!=t.match(regexLib.fixed)?"fixed":null!=t.match(regexLib.ignored)?"ignored":void 0},extractBlocks=function(t){for(var e,n,i=[],l=null,s=0,a=t.length;s<a;s++)null!=(n=(e=t[s]).match(/^(#{1})\s+([^#].*)$/))?(null!==l&&i.push(l),l={type:getBlockType(n[2]),name:n[2],lines:[]}):null!==l&&l.lines.push(e);return null!==l&&i.push(l),i},randomNum=function(t,e){e=Math.random()*(e-t)+t;return Math.floor(e)},searchElem=function(t,e){for(var n,i=0,l=e.length;i<l;i++)if(`[${(n=e[i]).name}]`===t&&null!=n)return n.number},toPDF=function(t,e){var n;return t=(t+="<style>body{font-size:1.3em;}a{color:black;font-weight:bold;text-decoration:none;pointer-events:none;}</style>").replace(/href=\"(.*?)\"/gm,""),(n=document.createElement("div")).id="content",n.innerHTML=t,t={filename:e.title+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2},margin:.7,enableLinks:!0,pagebreak:{mode:"avoid-all"},jsPDF:{unit:"in",format:"letter",orientation:"portrait"}},html2pdf().set(t).from(n).save()},toHTML=function(t,e){return t=`<!DOCTYPE html>
	<html lang="${e.lang}">
	<head>
    			<meta charset="UTF-8">
    			<meta http-equiv="X-UA-Compatible" content="IE=edge">
    			<meta name="viewport" content="width=device-width, initial-scale=1.0">
   				<title>${e.title}</title>
	</head>
	<body>
		${t}
	</body>
</html>`},toEPUB=async function(t,e){var n=t.split("\n");return n.splice(0,1),n.splice(0,1),t=n.join("\n"),(n=new jEpub).init({i18n:e.lang,title:e.title,author:e.author,publisher:e.publisher,description:e.description,tags:e.tags}),n.date(new Date),n.add("Librojuego",t),t=await n.generate("blob"),n=e.title+".epub",(e=document.createElement("a")).download=n,e.innerHTML="Download File",null!=window.webkitURL?e.href=window.webkitURL.createObjectURL(t):(e.href=window.URL.createObjectURL(t),e.onclick=destroyClickedElement,e.style.display="none",document.body.appendChild(e)),e.click()},toDOCX=function(t,e){t=htmlDocx.asBlob(t);return saveAs(t,e.title+".docx")},saveTextFile=function(t,e,n){e=e.title+"."+n,n=new Blob([t],{type:"text/plain"}),t=document.createElement("a");return t.download=e,t.innerHTML="Download File",null!=window.webkitURL?t.href=window.webkitURL.createObjectURL(n):(t.href=window.URL.createObjectURL(n),t.onclick=destroyClickedElement,t.style.display="none",document.body.appendChild(t)),t.click()},Talos=class{constructor(t,e,n){this.storySrc=t,this.info=e,this.settings=n,this.converter=new markdownit({html:!0}),this.yaml=null,this.src="",this.story={}}compile(N=""){var t,e,n,i,l,s,a,o,r,h,m,c,u,d,p,f,b,y,F,P,B,z,H,S,_,q,V,X,Y,J,W,Z,G,K,Q,g,tt,et,$,nt,k,it,lt,R,x,E,w,st,L,v,T,O,at,ot,rt,ht,mt,ct,ut,dt,pt,ft,A,U,D,C,j,I,M,bt,yt,gt;for(this.info.html(""),this.info.html(this.info.html()+"<span><i>[0/8] Estableciendo configuración inicial...</i></span></br>"),this.story=JSON.parse(JSON.stringify(this.storySrc)),this.yaml=null,this.src="",this.info.html(this.info.html()+"<span><i>[1/8] Procesando cabecera del documento...</i></span></br>"),this.yaml=jsyaml.load(this.story.yml),null!=this.yaml.title?this.src+=`<h1 style='font-size: 2.5em; text-align: center'>${this.yaml.title}</h1>

`:this.yaml.title="Sin Título",null!=this.yaml.author?this.src+=`<h1 style='font-style: italic; text-align: center;margin-bottom: 2em;'>${this.yaml.author}</h1>

`:this.yaml.author="Anónimo",null==this.yaml.lang&&(this.yaml.lang="es"),null==this.yaml.publisher&&(this.yaml.publisher=""),null==this.yaml.description&&(this.yaml.description=""),null==this.yaml.tags&&(this.yaml.tags=[]),null==this.yaml.turn_to?this.yaml.turn_to="":this.yaml.turn_to=` ${this.yaml.turn_to} `,this.info.html(this.info.html()+"<span><i>[2/8] Recolectando secciones fijas...</i></span></br>"),o=[],n=null,m=c=0,F=(at=this.story.blocks).length;m<F;m++)"fixed"===(l=at[m]).type&&(n={blockIndex:c,number:parseInt(l.name)},o.push(n)),c++;for(f=c=0,P=(ot=this.story.blocks).length;f<P;f++){for(b=p=0,X=(rt=(l=ot[f]).lines).length;b<X;b++)null!=(g=rt[b]).match(regexLib.div)&&(this.story.blocks[c].lines[p]=""),p++;c++}for(this.info.html(this.info.html()+"<span><i>[3/8] Asignando números aleatorios a las secciones no numeradas...</i></span></br>"),$=[],it=[],n=null,w=[],y=R=x=i=d=c=0,Y=(ht=this.story.blocks).length;y<Y;y++){if("fixed"===(l=ht[y]).type){if($.push(l.name),o[d].number===parseInt(l.name)){if(null!=o[d+1]){if(x=o[d].number,R=o[d+1].number,A=x+(i=o[d+1].blockIndex-c-1)+1,R<x)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El numero de la sección <b>${x}</b> es mayor que el de la sección siguiente: <b>${R}</b>.</span><br/>`),`ERROR: El numero de la sección ${x} es mayor que el de la sección siguiente: ${R}.`;if(R<A)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: La cantidad de secciones anteriores a <b>${R}</b> le superan por ${A-R}.</span><br/>`),`ERROR: La cantidad de secciones anteriores a ${R} le superan por ${A-R}.`;A<R&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: La cantidad de secciones anteriores a <b>${R}</b> son insuficientes, faltan ${R-A}.</span><br/>`)}else i=this.story.blocks.length-o[d].number,R=this.story.blocks.length;for(e=x+1,w=[];e<=x+i;)w.push(e),e++}d++}else"normal"===l.type&&($.push(l.name),A=randomNum(0,w.length),n={name:l.name,number:w[A],index:c},this.story.blocks[c].name=String(w[A]),w.splice(A,1),it.push(n));c++}for(k=u=c=0,J=(nt=$).length;k<J;k++){for(r=$[k],E=u=0,W=nt.length;E<W;E++){if(r===nt[E]&&c!==u)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El nombre de la sección <b>${r}</b> se repite en otra sección.</span><br/>`),`ERROR: El nombre de la sección ${r} se repite en otra sección.`;u++}c++}for(this.info.html(this.info.html()+"<span><i>[4/8] Reasignando enlaces a las secciones numeradas...</i></span></br>"),tt={},L=c=0,Z=(mt=this.story.blocks).length;L<Z;L++){for(T=p=0,G=(ct=(l=mt[L]).lines).length;T<G;T++){if(null!=(lt=(g=ct[T]).match(regexLib.link)))for(O=0,K=lt.length;O<K;O++){for(et=!(tt[""+(t=(t=(D=lt[O]).replace("[","")).replace("]",""))]=!0),U=0,Q=$.length;U<Q;U++)$[U]===t&&(et=!0);et||this.info.html(`${this.info.html()}<span style='color: darkgoldenrod;'>ADVERTENCIA: La sección <b>${t}</b>  a la que apunta <b>${l.name}</b> no existe.</span><br/>`),st=isNaN(t)?searchElem(D,it):t,g=g.replaceAll(D,this.yaml.turn_to+`[${st}](#${st})`)}this.story.blocks[c].lines[p]=g,p++}c++}for(this.info.html(this.info.html()+"<span><i>[5/8] Examinando si hay secciones huérfanas...</i></span></br>"),v=[],C=0,B=$.length;C<B;C++)tt[D=$[C]]||v.push(D);if(v)for(j=0,z=v.length;j<z;j++)"1"!==(D=v[j])&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: Ningún enlace apunta a la sección <b>${D}</b>.</span><br/>`);for(this.info.html(this.info.html()+"<span><i>[6/8] Organizando las secciones en orden secuencial...</i></span></br>"),a=[],I=c=0,H=(ut=this.story.blocks).length;I<H;I++){if("ignored"===(l=ut[I]).type)for(this.src+=`<h1 style='text-align: center;'>${l.name}</h1>

`,M=0,S=(dt=l.lines).length;M<S;M++)g=dt[M],this.src+=g+`
`;else if("fixed"===l.type){if(null!=a)for(a.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),bt=0,_=a.length;bt<_;bt++)for(s=a[bt],this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;'>${s.name}</h1>

`,yt=0,q=(pt=s.lines).length;yt<q;yt++)g=pt[yt],this.src+=g+`
`;for(a=[],this.src+=`<h1 id='${l.name}' name='${l.name}' style='text-align: center;'>${l.name}</h1>

`,gt=0,V=(ft=l.lines).length;gt<V;gt++)g=ft[gt],this.src+=g+`
`}else"normal"===l.type&&a.push(l);c++}return this.info.html(this.info.html()+"<span><i>[7/8] Renderizando documento...</i></span></br>"),h=this.converter.render(this.src),"preview"===N?(this.info.html(this.info.html()+"<span><i>[8/8] Visualizando documento en vista previa...</i></span></br>"),h):"review"===N?(this.info.html(this.info.html()+"<span><i>[8/8] Compilación exitosa...</i></span></br>"),h):(this.info.html(`${this.info.html()}<span><i>[8/8] Exportando el documento a formato <b>${this.yaml.output}</b>...</i></span></br>`),null!=this.yaml.output?"pdf"===this.yaml.output?toPDF(h,this.yaml):"html"===this.yaml.output?saveTextFile(toHTML(h,this.yaml),this.yaml,"html"):"epub"===this.yaml.output?toEPUB(h,this.yaml):"docx"===this.yaml.output?toDOCX(h,this.yaml):(this.info.html(`${this.info.html}<span style='color: darkred;'>ERROR: El formato de salida <b>*.${this.yaml.output}</b> no está soportado por Talos. Pruebe con: html, epub, docx y pdf.</span></br>`),`ERROR: El formato de salida *.${this.yaml.output} no está soportado por Talos. Pruebe con: html, epub, docx y pdf.`):saveTextFile(toHTML(h,this.yaml),this.yaml,"html"))}};