var test=null,regexLib={normal:/^[a-z][a-z_0-9]*\s{0,1}(.*)$/m,fixed:/^[0-9]+\s{0,1}(.*)$/m,ignored:/^[A-Z].*$/m,link:/\[([^\[\]]+)\](?!\(|\:|{)/gm},parseText=function(t){t=t.split(/\n|\r\n/);return{yml:extractYAML(t),blocks:extractBlocks(t)}},extractYAML=function(t){for(var e,l,n,i=[],o="",s=!0,a=!1,r=0,h=t.length;r<h;r++)n=t[r],s&&!a?n.startsWith("---")?a=!(s=!1):s=!1:!s&&a&&(n.startsWith("---")?a=s=!1:i.push(n));for(e=0,l=i.length;e<l;e++)o+=i[e]+"\n";return o},getBlockType=function(t){return null!=t.match(regexLib.normal)?"normal":null!=t.match(regexLib.fixed)?"fixed":null!=t.match(regexLib.ignored)?"ignored":void 0},extractBlocks=function(t){for(var e,l,n=[],i=null,o=0,s=t.length;o<s;o++)null!=(l=(e=t[o]).match(/^(#{1})\s+([^#].*)$/))?(null!==i&&n.push(i),i={type:getBlockType(l[2]),name:l[2],lines:[]}):null!==i&&i.lines.push(e);return null!==i&&n.push(i),n},randomNum=function(t,e){e=Math.random()*(e-t)+t;return Math.floor(e)},searchElem=function(t,e){for(var l,n=0,i=e.length;n<i;n++)if(`[${(l=e[n]).name}]`===t&&null!=l)return console.log(l.name),console.log(l.number),l.number},toPDF=function(t,e){var l;return t=(t+="<style>body{font-size:1.3em;}a{color:black;font-weight:bold;text-decoration:none;pointer-events:none;}</style>").replace(/href=\"(.*?)\"/gm,""),(l=document.createElement("div")).id="content",l.innerHTML=t,t={filename:e.title+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2},margin:.7,enableLinks:!0,pagebreak:{mode:"avoid-all"},jsPDF:{unit:"in",format:"letter",orientation:"portrait"}},html2pdf().set(t).from(l).save()},toHTML=function(t,e){return t=`<!DOCTYPE html>
	<html lang="${e.lang}">
	<head>
    			<meta charset="UTF-8">
    			<meta http-equiv="X-UA-Compatible" content="IE=edge">
    			<meta name="viewport" content="width=device-width, initial-scale=1.0">
   				<title>${e.title}</title>
	</head>
	<body>
		${t}
	</body>
</html>`},toEPUB=async function(t,e){var l=t.split("\n");return l.splice(0,1),l.splice(0,1),t=l.join("\n"),(l=new jEpub).init({i18n:e.lang,title:e.title,author:e.author,publisher:e.publisher,description:e.description,tags:e.tags}),l.date(new Date),l.add("Librojuego",t),t=await l.generate("blob"),l=e.title+".epub",(e=document.createElement("a")).download=l,e.innerHTML="Download File",null!=window.webkitURL?e.href=window.webkitURL.createObjectURL(t):(e.href=window.URL.createObjectURL(t),e.onclick=destroyClickedElement,e.style.display="none",document.body.appendChild(e)),e.click()},toDOCX=function(t,e){t=htmlDocx.asBlob(t);return saveAs(t,e.title+".docx")},saveTextFile=function(t,e,l){e=e.title+"."+l,l=new Blob([t],{type:"text/plain"}),t=document.createElement("a");return t.download=e,t.innerHTML="Download File",null!=window.webkitURL?t.href=window.webkitURL.createObjectURL(l):(t.href=window.URL.createObjectURL(l),t.onclick=destroyClickedElement,t.style.display="none",document.body.appendChild(t)),t.click()},Talos=class{constructor(t,e){this.story=t,this.settings=e,this.converter=new markdownit({html:!0}),this.container=$("#talos-play"),this.keywords={},this.history={},this.yaml,this.src="",this.currentSection=null}play(){return console.log("test")}compile(){var t,e,l,n,i,o,s,a,r,h,m,c,u,d,y,p,f,g,b,k,x,w,L,A,I,H,v,$,T,E,U,R,j,D,M,F,B,P,_,z,N,S,X,Y,q,C,O;for(this.yaml=jsyaml.load(this.story.yml),null!=this.yaml.title?this.src+=`<h1 style='font-size: 2.5em; text-align: center'>${this.yaml.title}</h1>

`:this.yaml.title="Sin Título",null!=this.yaml.author?this.src+=`<h1 style='font-style: italic; text-align: center;margin-bottom: 2em;'>${this.yaml.author}</h1>

`:this.yaml.author="Anónimo",null==this.yaml.lang&&(this.yaml.lang="es"),null==this.yaml.publisher&&(this.yaml.publisher=""),null==this.yaml.description&&(this.yaml.description=""),null==this.yaml.tags&&(this.yaml.tags=[]),null==this.yaml.turn_to?this.yaml.turn_to="":this.yaml.turn_to=` ${this.yaml.turn_to} `,a=[],e=null,h=m=0,f=(P=this.story.blocks).length;h<f;h++)"fixed"===(n=P[h]).type&&(e={blockIndex:m,number:parseInt(n.name)},a.push(e)),m++;for(T=[],e=null,j=[],d=U=l=c=m=0,g=(_=this.story.blocks).length;d<g;d++){if("fixed"===(n=_[d]).type){if(a[c].number===parseInt(n.name)){if(null!=a[c+1]){if(U=a[c].number,a[c+1].number<U+(l=a[c+1].blockIndex-m-1)+1){console.log("ERROR: La cantidad de secciones supera el numero fijo");break}}else l=this.story.blocks.length-a[c].number,this.story.blocks.length;for(t=U+1,j=[];t<=U+l;)j.push(t),t++}c++}else"normal"===n.type&&(s=randomNum(0,j.length),e={name:n.name,number:j[s],index:m},this.story.blocks[m].name=String(j[s]),j.splice(s,1),T.push(e));m++}for(y=m=0,b=(z=this.story.blocks).length;y<b;y++){for(p=u=0,k=(N=(n=z[y]).lines).length;p<k;p++){if(null!=(E=(v=N[p]).match(regexLib.link)))for($=0,x=E.length;$<x;$++)D=(D=(O=E[$]).replace("[","")).replace("]",""),D=isNaN(D)?searchElem(O,T):D,v=v.replaceAll(O,this.yaml.turn_to+`[${D}](#${D})`);this.story.blocks[m].lines[u]=v,u++}m++}for(console.log(this.story.blocks),o=[],R=m=0,w=(S=this.story.blocks).length;R<w;R++){if("ignored"===(n=S[R]).type)for(this.src+=`<h1 style='text-align: center;'>${n.name}</h1>

`,M=0,L=(X=n.lines).length;M<L;M++)v=X[M],this.src+=v+`
`;else if("fixed"===n.type){if(null!=o)for(o.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),F=0,A=o.length;F<A;F++)for(i=o[F],this.src+=`<h1 id='${i.name}' name='${i.name}' style='text-align: center;'>${i.name}</h1>

`,B=0,I=(Y=i.lines).length;B<I;B++)v=Y[B],this.src+=v+`
`;for(o=[],this.src+=`<h1 id='${n.name}' name='${n.name}' style='text-align: center;'>${n.name}</h1>

`,C=0,H=(q=n.lines).length;C<H;C++)v=q[C],this.src+=v+`
`}else"normal"===n.type&&o.push(n);m++}return console.log(this.src),r=this.converter.render(this.src),null!=this.yaml.output?"pdf"===this.yaml.output?toPDF(r,this.yaml):"html"===this.yaml.output?saveTextFile(toHTML(r,this.yaml),this.yaml,"html"):"epub"===this.yaml.output?toEPUB(r,this.yaml):"docx"===this.yaml.output?toDOCX(r,this.yaml):console.log(`El formato de salida *.${this.yaml.output} no está soportado por Talos.

Los formatos soportados son: html, epub, docx y pdf.`):saveTextFile(toHTML(r,this.yaml),this.yaml,"html")}};