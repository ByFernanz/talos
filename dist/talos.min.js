var test=null,regexLib={normal:/^[a-z][a-z_0-9]*\s{0,1}(.*)$/m,fixed:/^[0-9]+\s{0,1}(.*)$/m,ignored:/^[A-Z].*$/m,link:/\[([^\[\]]+)\](?!\(|\:|{)/gm},parseText=function(t){t=t.split(/\n|\r\n/);return{yml:extractYAML(t),blocks:extractBlocks(t)}},extractYAML=function(t){for(var e,n,l,i=[],s="",a=!0,o=!1,r=0,h=t.length;r<h;r++)l=t[r],a&&!o?l.startsWith("---")?o=!(a=!1):a=!1:!a&&o&&(l.startsWith("---")?o=a=!1:i.push(l));for(e=0,n=i.length;e<n;e++)s+=i[e]+"\n";return s},getBlockType=function(t){return null!=t.match(regexLib.normal)?"normal":null!=t.match(regexLib.fixed)?"fixed":null!=t.match(regexLib.ignored)?"ignored":void 0},extractBlocks=function(t){for(var e,n,l=[],i=null,s=0,a=t.length;s<a;s++)null!=(n=(e=t[s]).match(/^(#{1})\s+([^#].*)$/))?(null!==i&&l.push(i),i={type:getBlockType(n[2]),name:n[2],lines:[]}):null!==i&&i.lines.push(e);return null!==i&&l.push(i),l},randomNum=function(t,e){e=Math.random()*(e-t)+t;return Math.floor(e)},searchElem=function(t,e){for(var n,l=0,i=e.length;l<i;l++)if(`[${(n=e[l]).name}]`===t&&null!=n)return n.number},toPDF=function(t,e){var n;return t=(t+="<style>body{font-size:1.3em;}a{color:black;font-weight:bold;text-decoration:none;pointer-events:none;}</style>").replace(/href=\"(.*?)\"/gm,""),(n=document.createElement("div")).id="content",n.innerHTML=t,t={filename:e.title+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2},margin:.7,enableLinks:!0,pagebreak:{mode:"avoid-all"},jsPDF:{unit:"in",format:"letter",orientation:"portrait"}},html2pdf().set(t).from(n).save()},toHTML=function(t,e){return t=`<!DOCTYPE html>
	<html lang="${e.lang}">
	<head>
    			<meta charset="UTF-8">
    			<meta http-equiv="X-UA-Compatible" content="IE=edge">
    			<meta name="viewport" content="width=device-width, initial-scale=1.0">
   				<title>${e.title}</title>
	</head>
	<body>
		${t}
	</body>
</html>`},toEPUB=async function(t,e){var n=t.split("\n");return n.splice(0,1),n.splice(0,1),t=n.join("\n"),(n=new jEpub).init({i18n:e.lang,title:e.title,author:e.author,publisher:e.publisher,description:e.description,tags:e.tags}),n.date(new Date),n.add("Librojuego",t),t=await n.generate("blob"),n=e.title+".epub",(e=document.createElement("a")).download=n,e.innerHTML="Download File",null!=window.webkitURL?e.href=window.webkitURL.createObjectURL(t):(e.href=window.URL.createObjectURL(t),e.onclick=destroyClickedElement,e.style.display="none",document.body.appendChild(e)),e.click()},toDOCX=function(t,e){t=htmlDocx.asBlob(t);return saveAs(t,e.title+".docx")},saveTextFile=function(t,e,n){e=e.title+"."+n,n=new Blob([t],{type:"text/plain"}),t=document.createElement("a");return t.download=e,t.innerHTML="Download File",null!=window.webkitURL?t.href=window.webkitURL.createObjectURL(n):(t.href=window.URL.createObjectURL(n),t.onclick=destroyClickedElement,t.style.display="none",document.body.appendChild(t)),t.click()},Talos=class{constructor(t,e){this.story=t,this.settings=e,this.converter=new markdownit({html:!0}),this.container=$("#talos-play"),this.info=$("#talos-info"),this.keywords={},this.history={},this.yaml,this.src="",this.currentSection=null}play(){return console.log("test")}compile(){var t,e,n,l,i,s,a,o,r,h,m,c,u,d,y,p,F,B,N,P,H,_,q,z,S,V,X,Y,W,f,b,g,k,x,w,Z,$,L,E,v,G,R,T,U,A,J,K,Q,tt,et,nt,lt,it,D,C,j,I,M,O;for(this.info.html(""),this.yaml=jsyaml.load(this.story.yml),null!=this.yaml.title?this.src+=`<h1 style='font-size: 2.5em; text-align: center'>${this.yaml.title}</h1>

`:this.yaml.title="Sin Título",null!=this.yaml.author?this.src+=`<h1 style='font-style: italic; text-align: center;margin-bottom: 2em;'>${this.yaml.author}</h1>

`:this.yaml.author="Anónimo",null==this.yaml.lang&&(this.yaml.lang="es"),null==this.yaml.publisher&&(this.yaml.publisher=""),null==this.yaml.description&&(this.yaml.description=""),null==this.yaml.tags&&(this.yaml.tags=[]),null==this.yaml.turn_to?this.yaml.turn_to="":this.yaml.turn_to=` ${this.yaml.turn_to} `,o=[],n=null,h=m=0,F=(J=this.story.blocks).length;h<F;h++)"fixed"===(i=J[h]).type&&(n={blockIndex:m,number:parseInt(i.name)},o.push(n)),m++;for(k=[],w=[],n=null,v=[],d=$=L=l=c=m=0,B=(K=this.story.blocks).length;d<B;d++){if("fixed"===(i=K[d]).type){if(k.push(i.name),o[c].number===parseInt(i.name)){if(null!=o[c+1]){if(L=o[c].number,$=o[c+1].number,D=L+(l=o[c+1].blockIndex-m-1)+1,$<L)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El numero de la sección <b>${L}</b> es mayor que el de la sección siguiente: <b>${$}</b>.</span><br/>`),this.info.text();if($<D)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: La cantidad de secciones anteriores a <b>${$}</b> le superan por ${D-$}.</span><br/>`),this.info.text();D<$&&this.info.html(this.info.html()+`<span style='color: darkyellow;'>ADVERTENCIA: La cantidad de secciones anteriores a <b>${$}</b> son insuficientes, faltan ${$-D}.</span><br/>`)}else l=this.story.blocks.length-o[c].number,$=this.story.blocks.length;for(e=L+1,v=[];e<=L+l;)v.push(e),e++}c++}else"normal"===i.type&&(k.push(i.name),D=randomNum(0,v.length),n={name:i.name,number:v[D],index:m},this.story.blocks[m].name=String(v[D]),v.splice(D,1),w.push(n));m++}for(b={},y=m=0,_=(Q=this.story.blocks).length;y<_;y++){for(p=u=0,q=(tt=(i=Q[y]).lines).length;p<q;p++){if(null!=(Z=(f=tt[p]).match(regexLib.link)))for(x=0,z=Z.length;x<z;x++){for(g=!(b[""+(t=(t=(j=Z[x]).replace("[","")).replace("]",""))]=!0),E=0,S=k.length;E<S;E++)k[E]===t&&(g=!0);g||this.info.html(`${this.info.html()}<span style='color: darkyellow;'>ADVERTENCIA: La sección <b>${t}</b>  a la que apunta <b>${i.name}</b> no existe.</span><br/>`),G=isNaN(t)?searchElem(j,w):t,f=f.replaceAll(j,this.yaml.turn_to+`[${G}](#${G})`)}this.story.blocks[m].lines[u]=f,u++}m++}for(T=[],R=0,V=k.length;R<V;R++)b[j=k[R]]||T.push(j);if(T)for(U=0,X=T.length;U<X;U++)"1"!==(j=T[U])&&this.info.html(this.info.html()+`<span style='color: darkyellow;'>ADVERTENCIA: Ningún enlace apunta a la sección <b>${j}</b>.</span><br/>`);for(a=[],A=m=0,Y=(et=this.story.blocks).length;A<Y;A++){if("ignored"===(i=et[A]).type)for(this.src+=`<h1 style='text-align: center;'>${i.name}</h1>

`,C=0,W=(nt=i.lines).length;C<W;C++)f=nt[C],this.src+=f+`
`;else if("fixed"===i.type){if(null!=a)for(a.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),I=0,N=a.length;I<N;I++)for(s=a[I],this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;'>${s.name}</h1>

`,M=0,P=(lt=s.lines).length;M<P;M++)f=lt[M],this.src+=f+`
`;for(a=[],this.src+=`<h1 id='${i.name}' name='${i.name}' style='text-align: center;'>${i.name}</h1>

`,O=0,H=(it=i.lines).length;O<H;O++)f=it[O],this.src+=f+`
`}else"normal"===i.type&&a.push(i);m++}return r=this.converter.render(this.src),null!=this.yaml.output?"pdf"===this.yaml.output?toPDF(r,this.yaml):"html"===this.yaml.output?saveTextFile(toHTML(r,this.yaml),this.yaml,"html"):"epub"===this.yaml.output?toEPUB(r,this.yaml):"docx"===this.yaml.output?toDOCX(r,this.yaml):this.info.html(`${this.info.html}<span style='color: darkred;'>ERROR: El formato de salida <b>*.${this.yaml.output}</b> no está soportado por Talos. Pruebe con: html, epub, docx y pdf.</span></br>`):saveTextFile(toHTML(r,this.yaml),this.yaml,"html")}};