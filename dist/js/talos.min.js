var test=null,test2=null,regexLib={normal:/^[a-z][a-z_0-9]*\s{0,1}(.*)$/m,fixed:/^[0-9]+\s{0,1}(.*)$/m,ignored:/^[A-Z].*$/m,link:/\[([^\[\]]+)\](?!\(|\:|{)/gm,div:/^(\:{3,}).*/m},parseText=function(t){t=t.split(/\n|\r\n/);return{yml:extractYAML(t),blocks:extractBlocks(t)}},extractYAML=function(t){for(var e,i,n,l=[],s="",a=!0,o=!1,h=0,r=t.length;h<r;h++)n=t[h],a&&!o?n.startsWith("---")?o=!(a=!1):a=!1:!a&&o&&(n.startsWith("---")?o=a=!1:l.push(n));for(e=0,i=l.length;e<i;e++)s+=l[e]+"\n";return s},getBlockType=function(t){return null!=t.match(regexLib.normal)?"normal":null!=t.match(regexLib.fixed)?"fixed":null!=t.match(regexLib.ignored)?"ignored":void 0},extractBlocks=function(t){for(var e,i,n=[],l=null,s=0,a=t.length;s<a;s++)null!=(i=(e=t[s]).match(/^(#{1})\s{1}([\p{Letter}\s\d\w]{0,}[\p{Letter}\d\w])/mu))?(null!==l&&n.push(l),l={type:getBlockType(i[2]),name:i[2],lines:[]},null!=(i=e.match(/"([^"]*)"/mu))&&(l.title=i[1])):null!==l&&l.lines.push(e);return null!==l&&n.push(l),n},randomNum=function(t,e){e=Math.random()*(e-t)+t;return Math.floor(e)},toPDF=function(t,e){return t=t.replace(/style='(.*?)'/gm,""),t=htmlToPdfmake(t,{defaultStyles:{font:"OpenSans",a:{color:"black",decoration:"",bold:!0},h1:{alignment:"center"},h2:{fontSize:18,alignment:"center"}}}),pdfMake.createPdf({content:t}).download(""+e.title)},toHTML=function(t,e){return t=`<!DOCTYPE html>
	<html lang="${e.lang}">
	<head>
    			<meta charset="UTF-8">
    			<meta http-equiv="X-UA-Compatible" content="IE=edge">
    			<meta name="viewport" content="width=device-width, initial-scale=1.0">
   				<title>${e.title}</title>
	</head>
	<body>
		${t}
	</body>
</html>`},toEPUB=async function(t,e){var i=t.split("\n");return i.splice(0,1),i.splice(0,1),t=i.join("\n"),(i=new jEpub).init({i18n:e.lang,title:e.title,author:e.author,publisher:e.publisher,description:e.description,tags:e.tags}),i.date(new Date),i.add("Librojuego",t),t=await i.generate("blob"),i=e.title+".epub",(e=document.createElement("a")).download=i,e.innerHTML="Download File",null!=window.webkitURL?e.href=window.webkitURL.createObjectURL(t):(e.href=window.URL.createObjectURL(t),e.onclick=destroyClickedElement,e.style.display="none",document.body.appendChild(e)),e.click()},toDOCX=function(t,e){var i;return t=`<!DOCTYPE html>
	<html lang="${e.lang}">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   				<title>${e.title}</title>
	</head>
	<body>
		${t}
	</body>
</html>`,i=htmlDocx.asBlob(t),htmlDocx.asBlob(t),saveTextFile(i,e,"docx")},saveTextFile=function(t,e,i){e=e.title+"."+i,i=new Blob([t],{type:"text/plain"}),t=document.createElement("a");return t.download=e,t.innerHTML="Download File",null!=window.webkitURL?t.href=window.webkitURL.createObjectURL(i):(t.href=window.URL.createObjectURL(i),t.onclick=destroyClickedElement,t.style.display="none",document.body.appendChild(t)),t.click()},Talos=class{constructor(t,e,i){this.storySrc=t,this.info=e,this.settings=i,this.converter=new markdownit({html:!0}).use(window.markdownitEmoji),this.yaml=null,this.src="",this.story={}}compile(j=""){var t,e,i,n,l,s,a,o,h,F,r,m,c,u,d,p,y,b,f,g,$,x,k,R,w,M,N,S,B,z,q,H,V,Y,X,J,W,Z,G,K,Q,tt,et,it,nt,lt,E,st,at,L,ot,T,_,ht,v,O,A,rt,U,C,D,mt,ct,ut,dt,pt,yt,bt,ft,gt,$t,xt,kt,Rt,I,wt,P,Et,Lt,Tt,_t,vt,Ot,At;for(this.info.html(""),this.info.html(this.info.html()+"<span><i>[0/8] Estableciendo configuración inicial...</i></span></br>"),this.story=JSON.parse(JSON.stringify(this.storySrc)),this.yaml=null,this.src="",this.info.html(this.info.html()+"<span><i>[1/8] Procesando cabecera del documento...</i></span></br>"),this.yaml=jsyaml.load(this.story.yml),null==this.yaml&&(this.yaml={}),null!=this.yaml.title?this.src+=`<h1 style='font-size: 2.5em; text-align: center; line-height: 1.2em;'>${this.yaml.title}</h1>

`:this.yaml.title="Sin Título",null!=this.yaml.author?this.src+=`<h1 style='font-style: italic; text-align: center;margin-bottom: 2em;line-height: 1.2em;'>${this.yaml.author}</h1>

`:this.yaml.author="Anónimo",null==this.yaml.lang&&(this.yaml.lang="es"),null==this.yaml.publisher&&(this.yaml.publisher=""),null==this.yaml.description&&(this.yaml.description=""),null==this.yaml.output&&(this.yaml.output="html"),null==this.yaml.tags&&(this.yaml.tags=[]),null==this.yaml.turn_to?this.yaml.turn_to="":this.yaml.turn_to=this.yaml.turn_to+" ",i=0,this.info.html(this.info.html()+"<span><i>[2/8] Recolectando secciones fijas...</i></span></br>"),r=[],n=null,u=p=0,M=(ut=this.story.blocks).length;u<M;u++)"fixed"===(s=ut[u]).type&&(n={blockIndex:p,number:parseInt(s.name)},s.title&&(n.title=s.title),r.push(n)),"normal"===s.type&&i++,p++;for(g=p=0,N=(dt=this.story.blocks).length;g<N;g++){for(x=f=0,Z=(yt=(s=dt[g]).lines).length;x<Z;x++)null!=(E=yt[x]).match(regexLib.div)&&(this.story.blocks[p].lines[f]=""),f++;p++}for(this.info.html(this.info.html()+"<span><i>[3/8] Asignando números aleatorios a las secciones no numeradas...</i></span></br>"),L=[],_=[],n=null,U=[],R=v=O=l=b=p=0,K=(bt=this.story.blocks).length;R<K;R++){if("fixed"===(s=bt[R]).type){if(L.push(s.name),r[b].number===parseInt(s.name)){if(null!=r[b+1]){if(O=r[b].number,v=r[b+1].number,I=O+(l=r[b+1].blockIndex-p-1)+1,v<O)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El numero de la sección <b>${O}</b> es mayor que el de la sección siguiente: <b>${v}</b>.</span><br/>`),`<span style='color: darkred;'>ERROR: El numero de la sección <b>${O}</b> es mayor que el de la sección siguiente: <b>${v}</b>.</span><br/>`;if(v<I)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: La cantidad de secciones anteriores a <b>${v}</b> le superan por ${I-v}.</span><br/>`),`<span style='color: darkred;'>ERROR: La cantidad de secciones anteriores a <b>${v}</b> le superan por ${I-v}.</span><br/>`;I<v&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: La cantidad de secciones anteriores a <b>${v}</b> son insuficientes, faltan ${v-I}.</span><br/>`)}else v=l=i,O=r[b].number;for(e=O+1,U=[];e<=O+l;)U.push(e),e++}b++}else"normal"===s.type&&(i-=1,L.push(s.name),I=randomNum(0,U.length),n={name:s.name,number:U[I],index:p},s.title&&(n.title=s.title),this.story.blocks[p].name=String(U[I]),U.splice(I,1),_.push(n));p++}for(T=y=p=0,Q=(ot=L).length;T<Q;T++){for(m=L[T],A=y=0,tt=ot.length;A<tt;A++){if(m===ot[A]&&p!==y)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El nombre de la sección <b>${m}</b> se repite en otra sección.</span><br/>`),`<span style='color: darkred;'>ERROR: El nombre de la sección <b>${m}</b> se repite en otra sección.</span><br/>`;y++}p++}for(this.info.html(this.info.html()+"<span><i>[4/8] Reasignando enlaces a las secciones numeradas...</i></span></br>"),st={},C=p=0,et=(ft=this.story.blocks).length;C<et;C++){for(mt=f=0,it=(gt=(s=ft[C]).lines).length;mt<it;mt++){if(null!=(ht=(E=gt[mt]).match(regexLib.link)))for(ct=0,nt=ht.length;ct<nt;ct++){for(at=!(st[""+(t=(t=(P=ht[ct]).replace("[","")).replace("]",""))]=!0),wt=0,lt=L.length;wt<lt;wt++)L[wt]===t&&(at=!0);if(at||this.info.html(`${this.info.html()}<span style='color: darkgoldenrod;'>ADVERTENCIA: La sección <b>${t}</b>  a la que apunta <b>${this.storySrc.blocks[p].name}</b> no existe.</span><br/>`),isNaN(t))for(Et=0,S=_.length;Et<S;Et++)t===(rt=_[Et]).name&&(a=rt);else for(Lt=0,B=r.length;Lt<B;Lt++)F=r[Lt],parseInt(t)===F.number&&(a=F);E=null!=a?this.yaml.titled_sections&&a.title?"html"===this.yaml.output||"epub"===this.yaml.output?E.replaceAll(P,` ${this.yaml.turn_to}[${a.title}](#${a.number})`):E.replaceAll(P,` **${a.title}** (${this.yaml.turn_to}[${a.number}](#${a.number}))`):(test=_,E.replaceAll(P,` ${this.yaml.turn_to}[${a.number}](#${a.number})`)):E.replaceAll(P,` ${this.yaml.turn_to}[sección no definida](#no-definida)`)}this.story.blocks[p].lines[f]=E,f++}p++}for(this.info.html(this.info.html()+"<span><i>[5/8] Examinando si hay secciones huérfanas...</i></span></br>"),D=[],Tt=0,z=L.length;Tt<z;Tt++)st[P=L[Tt]]||D.push(P);if(D)for(_t=0,q=D.length;_t<q;_t++)"1"!==(P=D[_t])&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: Ningún enlace apunta a la sección <b>${P}</b>.</span><br/>`);for(this.info.html(this.info.html()+"<span><i>[6/8] Organizando las secciones en orden secuencial...</i></span></br>"),h=[],vt=p=0,H=($t=this.story.blocks).length;vt<H;vt++){if("ignored"===(s=$t[vt]).type)for(this.src+=`<h1 style='text-align: center;line-height: 1.2em;'>${s.name}</h1>

`,Ot=0,V=(xt=s.lines).length;Ot<V;Ot++)E=xt[Ot],this.src+=E+`
`;else if("fixed"===s.type){if(h)for(h.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),At=0,Y=h.length;At<Y;At++)for(o=h[At],!this.yaml.titled_sections||!o.title||this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?!this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?this.yaml.hide_sections||!this.yaml.titled_sections||!o.title||"pdf"!==this.yaml.output&&"docx"!==this.yaml.output?this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.name}</h1>

`:this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.name}</h1>

<h2>${o.title}</h2>

`:this.src+=`<hr id='${o.name}' name='${o.name}'/>

`:this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.title}</h1>

`,d=0,X=(kt=o.lines).length;d<X;d++)E=kt[d],this.src+=E+`
`;for(h=[],!this.yaml.titled_sections||!s.title||this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?!this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?this.yaml.hide_sections||!this.yaml.titled_sections||!s.title||"pdf"!==this.yaml.output&&"docx"!==this.yaml.output?this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;line-height: 1.2em;'>${s.name}</h1>

`:this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;line-height: 1.2em;'>${s.name}</h1>

<h2>${s.title}</h2>

`:this.src+=`<hr id='${s.name}' name='${s.name}'/>

`:this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;line-height: 1.2em;'>${s.title}</h1>

`,$=0,J=(Rt=s.lines).length;$<J;$++)E=Rt[$],this.src+=E+`
`}else"normal"===s.type&&h.push(s);p++}if(h)for(h.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),k=0,W=h.length;k<W;k++)for(o=h[k],!this.yaml.titled_sections||!o.title||this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?!this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?this.yaml.hide_sections||!this.yaml.titled_sections||!o.title||"pdf"!==this.yaml.output&&"docx"!==this.yaml.output?this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.name}</h1>

`:this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.name}</h1>

<h2>${o.title}</h2>

`:this.src+=`<hr id='${o.name}' name='${o.name}'/>

`:this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.title}</h1>

`,w=0,G=(pt=o.lines).length;w<G;w++)E=pt[w],this.src+=E+`
`;return h=[],this.info.html(this.info.html()+"<span><i>[7/8] Renderizando documento...</i></span></br>"),c=this.converter.render(this.src),"preview"===j?(this.info.html(this.info.html()+"<span><i>[8/8] Visualizando documento en vista previa...</i></span></br>"),c):"review"===j?(this.info.html(this.info.html()+"<span><i>[8/8] Compilación exitosa...</i></span></br>"),c):(this.info.html(`${this.info.html()}<span><i>[8/8] Exportando el documento a formato <b>${this.yaml.output}</b>...</i></span></br>`),null!=this.yaml.output?"pdf"===this.yaml.output?toPDF(c,this.yaml):"html"===this.yaml.output?saveTextFile(toHTML(c,this.yaml),this.yaml,"html"):"epub"===this.yaml.output?toEPUB(c,this.yaml):"docx"===this.yaml.output?toDOCX(c,this.yaml):(this.info.html(`${this.info.html}<span style='color: darkred;'>ERROR: El formato de salida <b>*.${this.yaml.output}</b> no está soportado por Talos. Pruebe con: html, epub, docx y pdf.</span></br>`),`<span style='color: darkred;'>ERROR: El formato de salida <b>*.${this.yaml.output}</b> no está soportado por Talos. Pruebe con: html, epub, docx y pdf.</span></br>`):saveTextFile(toHTML(c,this.yaml),this.yaml,"html"))}};