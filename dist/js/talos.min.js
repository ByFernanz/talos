var test=null,graph_book="",regexLib={normal:/^[a-z][a-z_0-9]*\s{0,1}(.*)$/m,fixed:/^[0-9]+\s{0,1}(.*)$/m,ignored:/^[A-Z].*$/m,link:/\[([^\[\]]+)\](?!\(|\:|{)/gm,div:/^(\:{3,}).*/m,comment:/<!--(.*?)-->/g},parseText=function(t){t=t.split(/\n|\r\n/),t=extractYAML(t);return{yml:t.ymlBlock,blocks:extractBlocks(t.cleanLines)}},extractYAML=function(t){for(var e,i,n,l=[],s="",a=!1,o=[],h=!1,r=!1,m=0,c=t.length;m<c;m++)n=t[m],(a=a||h||r||!n.startsWith("---")?a:!0)&&!h?n.startsWith("---")?h=!(a=!1):a=!1:!a&&h?n.startsWith("---")?r=!(h=a=!1):l.push(n):o.push(n);for(e=0,i=l.length;e<i;e++)s+=l[e]+"\n";return{ymlBlock:s,cleanLines:o}},extractClass=function(t){for(var e,i,n,l,s=[],a="",o=[],h=!1,r=!1,m=!0,c=0,u=t.length;c<u;c++){if((n=t[c]).startsWith(!o))return null;if(n.startsWith("# "))return o;if(!h&&!r&&m&&n.startsWith("==="))m=!1,l=n.replace(/(=|\s)/gm,""),s.push("name: "+l),r=!(h=!(h=!0));else if(!h&&r)if(n.startsWith("---")){for(m=!(r=h=!1),e=0,i=s.length;e<i;e++)a+=s[e]+"\n";o.push(a),a="",s=[]}else s.push(n)}},getBlockType=function(t){return null!=t.match(regexLib.normal)?"normal":null!=t.match(regexLib.fixed)?"fixed":null!=t.match(regexLib.ignored)?"ignored":void 0},extractBlocks=function(t){for(var e,i,n=[],l=null,s=0,a=t.length;s<a;s++)null!=(i=(e=t[s]).match(/^(#{1})\s{1}([\p{Letter}\s\d\w]{0,}[\p{Letter}\d\w])/mu))?(null!==l&&n.push(l),l={type:getBlockType(i[2]),name:i[2],lines:[]},null!=(i=e.match(/"([^"]*)"/mu))&&(l.title=i[1])):null!==l&&l.lines.push(e);return null!==l&&n.push(l),n},randomNum=function(t,e){e=Math.random()*(e-t)+t;return Math.floor(e)},toPDF=function(t,e){return t=t.replace(/style='(.*?)'/gm,""),t=htmlToPdfmake(t,{defaultStyles:{font:"OpenSans",a:{color:"black",decoration:"",bold:!0},h1:{alignment:"center"},h2:{fontSize:18,alignment:"center"}}}),pdfMake.createPdf({content:t}).download(""+e.title)},toHTML=function(t,e){return t=`<!DOCTYPE html>
	<html lang="${e.lang}">
	<head>
    			<meta charset="UTF-8">
    			<meta http-equiv="X-UA-Compatible" content="IE=edge">
    			<meta name="viewport" content="width=device-width, initial-scale=1.0">
   				<title>${e.title}</title>
	</head>
	<body>
		${t}
	</body>
</html>`},toEPUB=async function(t,e){var i=t.split("\n");return i.splice(0,1),i.splice(0,1),t=i.join("\n"),(i=new jEpub).init({i18n:e.lang,title:e.title,author:e.author,publisher:e.publisher,description:e.description,tags:e.tags}),i.date(new Date),i.add("Librojuego",t),t=await i.generate("blob"),i=e.title+".epub",(e=document.createElement("a")).download=i,e.innerHTML="Download File",null!=window.webkitURL?e.href=window.webkitURL.createObjectURL(t):(e.href=window.URL.createObjectURL(t),e.onclick=destroyClickedElement,e.style.display="none",document.body.appendChild(e)),e.click()},toDOCX=function(t,e){var i;return t=`<!DOCTYPE html>
	<html lang="${e.lang}">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   				<title>${e.title}</title>
	</head>
	<body>
		${t}
	</body>
</html>`,i=htmlDocx.asBlob(t),htmlDocx.asBlob(t),saveTextFile(i,e,"docx")},saveTextFile=function(t,e,i){e=e.title+"."+i,i=new Blob([t],{type:"text/plain"}),t=document.createElement("a");return t.download=e,t.innerHTML="Download File",null!=window.webkitURL?t.href=window.webkitURL.createObjectURL(i):(t.href=window.URL.createObjectURL(i),t.onclick=destroyClickedElement,t.style.display="none",document.body.appendChild(t)),t.click()},Talos=class{constructor(t,e,i){this.storySrc=t,this.info=e,this.settings=i,this.converter=new markdownit({html:!0}).use(window.markdownitEmoji),this.yaml=null,this.src="",this.story={}}compile(j=""){var t,e,i,n,l,s,a,o,h,M,r,m,c,u,d,p,y,b,f,g,$,k,x,R,w,P,F,N,S,z,W,q,H,Y,V,X,J,Z,G,K,Q,tt,et,it,nt,lt,st,L,at,ot,E,ht,_,T,v,rt,O,A,C,mt,U,ct,D,ut,dt,pt,yt,bt,ft,gt,$t,kt,xt,Rt,wt,Lt,Et,_t,I,Tt,B,vt,Ot,At,Ct,Ut,Dt,It;for(graph_book="",this.info.html(""),this.info.html(this.info.html()+"<span><i>[0/8] Estableciendo configuración inicial...</i></span></br>"),this.story=JSON.parse(JSON.stringify(this.storySrc)),this.yaml=null,this.src="",this.info.html(this.info.html()+"<span><i>[1/8] Procesando cabecera del documento...</i></span></br>"),this.yaml=jsyaml.load(this.story.yml),null==this.yaml&&(this.yaml={}),null!=this.yaml.title?this.src+=`<h1 style='font-size: 2.5em; text-align: center; line-height: 1.2em;'>${this.yaml.title}</h1>

`:this.yaml.title="Sin Título",null!=this.yaml.author?this.src+=`<h1 style='font-style: italic; text-align: center;margin-bottom: 2em;line-height: 1.2em;'>${this.yaml.author}</h1>

`:this.yaml.author="Anónimo",null==this.yaml.lang&&(this.yaml.lang="es"),null==this.yaml.publisher&&(this.yaml.publisher=""),null==this.yaml.description&&(this.yaml.description=""),null==this.yaml.output&&(this.yaml.output="html"),null==this.yaml.tags&&(this.yaml.tags=[]),null==this.yaml.turn_to?this.yaml.turn_to="":this.yaml.turn_to=this.yaml.turn_to+" ",u=p=0,P=(yt=this.story.blocks).length;u<P;u++)"fixed"!==(s=yt[u]).type&&"normal"!==s.type||(dt=extractYAML(this.story.blocks[p].lines),this.story.blocks[p].yaml=jsyaml.load(dt.ymlBlock),this.story.blocks[p].lines=dt.cleanLines),p++;for(i=0,this.info.html(this.info.html()+"<span><i>[2/8] Recolectando secciones fijas...</i></span></br>"),r=[],n=null,g=p=0,F=(bt=this.story.blocks).length;g<F;g++)"fixed"===(s=bt[g]).type&&(n={blockIndex:p,number:parseInt(s.name)},s.title?(n.title=s.title,this.story.blocks[p].yaml.title=s.title):s.yaml&&s.yaml.title&&(n.title=s.yaml.title,this.story.blocks[p].title=s.yaml.title),r.push(n)),"normal"===s.type&&i++,p++;for(k=p=0,Z=($t=this.story.blocks).length;k<Z;k++){for(R=f=0,Q=(kt=(s=$t[k]).lines).length;R<Q;R++)null!=(L=kt[R]).match(regexLib.div)&&(this.story.blocks[p].lines[f]=""),null!=L.match(regexLib.comment)&&(this.story.blocks[p].lines[f]=L.replace(regexLib.comment,"")),f++;p++}for(this.info.html(this.info.html()+"<span><i>[3/8] Asignando números aleatorios a las secciones no numeradas...</i></span></br>"),E=[],v=[],n=null,U=[],_=O=A=l=b=p=0,tt=(xt=this.story.blocks).length;_<tt;_++){if("fixed"===(s=xt[_]).type){if(E.push(s.name),r[b].number===parseInt(s.name)){if(null!=r[b+1]){if(A=r[b].number,O=r[b+1].number,I=A+(l=r[b+1].blockIndex-p-1)+1,O<A)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El numero de la sección <b>${A}</b> es mayor que el de la sección siguiente: <b>${O}</b>.</span><br/>`),`<span style='color: darkred;'>ERROR: El numero de la sección <b>${A}</b> es mayor que el de la sección siguiente: <b>${O}</b>.</span><br/>`;if(O<I)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: La cantidad de secciones anteriores a <b>${O}</b> le superan por ${I-O}.</span><br/>`),`<span style='color: darkred;'>ERROR: La cantidad de secciones anteriores a <b>${O}</b> le superan por ${I-O}.</span><br/>`;I<O&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: La cantidad de secciones anteriores a <b>${O}</b> son insuficientes, faltan ${O-I}.</span><br/>`)}else O=l=i,A=r[b].number;for(e=A+1,U=[];e<=A+l;)U.push(e),e++}b++}else"normal"===s.type&&(i-=1,E.push(s.name),I=randomNum(0,U.length),n={name:s.name,number:U[I],index:p},s.title?(n.title=s.title,this.story.blocks[p].yaml.title=s.title):s.yaml&&s.yaml.title&&(n.title=s.yaml.title,this.story.blocks[p].title=s.yaml.title),this.story.blocks[p].name=String(U[I]),U.splice(I,1),v.push(n));p++}for(C=y=p=0,et=(ht=E).length;C<et;C++){for(m=E[C],ct=y=0,it=ht.length;ct<it;ct++){if(m===ht[ct]&&p!==y)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El nombre de la sección <b>${m}</b> se repite en otra sección.</span><br/>`),`<span style='color: darkred;'>ERROR: El nombre de la sección <b>${m}</b> se repite en otra sección.</span><br/>`;y++}p++}for(this.info.html(this.info.html()+"<span><i>[4/8] Reasignando enlaces a las secciones numeradas...</i></span></br>"),at={},ut=p=0,nt=(Rt=this.story.blocks).length;ut<nt;ut++){for(pt=f=0,lt=(wt=(s=Rt[ut]).lines).length;pt<lt;pt++){if(null!=(rt=(L=wt[pt]).match(regexLib.link)))for(Tt=0,st=rt.length;Tt<st;Tt++){for(ot=!(at[""+(t=(t=(B=rt[Tt]).replace("[","")).replace("]",""))]=!0),vt=0,N=E.length;vt<N;vt++)E[vt]===t&&(ot=!0);if(ot||this.info.html(`${this.info.html()}<span style='color: darkgoldenrod;'>ADVERTENCIA: La sección <b>${t}</b>  a la que apunta <b>${this.storySrc.blocks[p].name}</b> no existe.</span><br/>`),isNaN(t))for(Ot=0,S=v.length;Ot<S;Ot++)t===(mt=v[Ot]).name&&(a=mt);else for(At=0,z=r.length;At<z;At++)M=r[At],parseInt(t)===M.number&&(a=M);L=null!=a?this.yaml.titled_sections&&a.title?"html"===this.yaml.output||"epub"===this.yaml.output?L.replaceAll(B,` ${this.yaml.turn_to}[${a.title}](#${a.number})`):L.replaceAll(B,` **${a.title}** (${this.yaml.turn_to}[${a.number}](#${a.number}))`):L.replaceAll(B,` ${this.yaml.turn_to}[${a.number}](#${a.number})`):L.replaceAll(B,` ${this.yaml.turn_to}[sección no definida](#no-definida)`)}this.story.blocks[p].lines[f]=L,f++}p++}for(this.info.html(this.info.html()+"<span><i>[5/8] Examinando si hay secciones huérfanas...</i></span></br>"),D=[],Ct=0,W=E.length;Ct<W;Ct++)at[B=E[Ct]]||D.push(B);if(D)for(Ut=0,q=D.length;Ut<q;Ut++)"1"!==(B=D[Ut])&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: Ningún enlace apunta a la sección <b>${B}</b>.</span><br/>`);for(this.info.html(this.info.html()+"<span><i>[6/8] Organizando las secciones en orden secuencial...</i></span></br>"),h=[],Dt=p=0,H=(Lt=this.story.blocks).length;Dt<H;Dt++){if("ignored"===(s=Lt[Dt]).type)for(this.src+=`<h1 style='text-align: center;line-height: 1.2em;'>${s.name}</h1>

`,It=0,Y=(Et=s.lines).length;It<Y;It++)L=Et[It],this.src+=L+`
`;else if("fixed"===s.type){if(h)for(h.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),d=0,V=h.length;d<V;d++)for(o=h[d],!this.yaml.titled_sections||!o.title||this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?!this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?this.yaml.hide_sections||!this.yaml.titled_sections||!o.title||"pdf"!==this.yaml.output&&"docx"!==this.yaml.output?this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.name}</h1>

`:this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.name}</h1>

<h2>${o.title}</h2>

`:this.src+=`<hr id='${o.name}' name='${o.name}'/>

`:this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.title}</h1>

`,graph_book+=`# ${o.name}
`,$=0,X=(_t=o.lines).length;$<X;$++)L=_t[$],this.src+=L+`
`,graph_book+=L+`
`;for(h=[],!this.yaml.titled_sections||!s.title||this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?!this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?this.yaml.hide_sections||!this.yaml.titled_sections||!s.title||"pdf"!==this.yaml.output&&"docx"!==this.yaml.output?this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;line-height: 1.2em;'>${s.name}</h1>

`:this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;line-height: 1.2em;'>${s.name}</h1>

<h2>${s.title}</h2>

`:this.src+=`<hr id='${s.name}' name='${s.name}'/>

`:this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;line-height: 1.2em;'>${s.title}</h1>

`,graph_book+=`# ${s.name}
`,x=0,J=(ft=s.lines).length;x<J;x++)L=ft[x],this.src+=L+`
`,graph_book+=L+`
`}else"normal"===s.type&&h.push(s);p++}if(h)for(h.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),w=0,G=h.length;w<G;w++)for(o=h[w],!this.yaml.titled_sections||!o.title||this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?!this.yaml.hide_sections||"html"!==this.yaml.output&&"epub"!==this.yaml.output?this.yaml.hide_sections||!this.yaml.titled_sections||!o.title||"pdf"!==this.yaml.output&&"docx"!==this.yaml.output?this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.name}</h1>

`:this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.name}</h1>

<h2>${o.title}</h2>

`:this.src+=`<hr id='${o.name}' name='${o.name}'/>

`:this.src+=`<h1 id='${o.name}' name='${o.name}' style='text-align: center;line-height: 1.2em;'>${o.title}</h1>

`,graph_book+=`# ${o.name}
`,T=0,K=(gt=o.lines).length;T<K;T++)L=gt[T],this.src+=L+`
`,graph_book+=L+`
`;return h=[],this.info.html(this.info.html()+"<span><i>[7/8] Renderizando documento...</i></span></br>"),test="",c=this.converter.render(this.src),"preview"===j?(this.info.html(this.info.html()+"<span><i>[8/8] Visualizando documento en vista previa...</i></span></br>"),c):"review"===j?(this.info.html(this.info.html()+"<span><i>[8/8] Compilación exitosa...</i></span></br>"),c):(this.info.html(`${this.info.html()}<span><i>[8/8] Exportando el documento a formato <b>${this.yaml.output}</b>...</i></span></br>`),null!=this.yaml.output?"pdf"===this.yaml.output?toPDF(c,this.yaml):"html"===this.yaml.output?saveTextFile(toHTML(c,this.yaml),this.yaml,"html"):"epub"===this.yaml.output?toEPUB(c,this.yaml):"docx"===this.yaml.output?toDOCX(c,this.yaml):(this.info.html(`${this.info.html}<span style='color: darkred;'>ERROR: El formato de salida <b>*.${this.yaml.output}</b> no está soportado por Talos. Pruebe con: html, epub, docx y pdf.</span></br>`),`<span style='color: darkred;'>ERROR: El formato de salida <b>*.${this.yaml.output}</b> no está soportado por Talos. Pruebe con: html, epub, docx y pdf.</span></br>`):saveTextFile(toHTML(c,this.yaml),this.yaml,"html"))}};