var test=null,regexLib={normal:/^[a-z][a-z_0-9]*\s{0,1}(.*)$/m,fixed:/^[0-9]+\s{0,1}(.*)$/m,ignored:/^[A-Z].*$/m,link:/\[([^\[\]]+)\](?!\(|\:|{)/gm,div:/^(\:{3,}).*/m},parseText=function(t){t=t.split(/\n|\r\n/);return{yml:extractYAML(t),blocks:extractBlocks(t)}},extractYAML=function(t){for(var e,n,i,s=[],l="",o=!0,a=!1,r=0,h=t.length;r<h;r++)i=t[r],o&&!a?i.startsWith("---")?a=!(o=!1):o=!1:!o&&a&&(i.startsWith("---")?a=o=!1:s.push(i));for(e=0,n=s.length;e<n;e++)l+=s[e]+"\n";return l},getBlockType=function(t){return null!=t.match(regexLib.normal)?"normal":null!=t.match(regexLib.fixed)?"fixed":null!=t.match(regexLib.ignored)?"ignored":void 0},extractBlocks=function(t){for(var e,n,i=[],s=null,l=0,o=t.length;l<o;l++)null!=(n=(e=t[l]).match(/^(#{1})\s+([^#].*)$/))?(null!==s&&i.push(s),s={type:getBlockType(n[2]),name:n[2],lines:[]}):null!==s&&s.lines.push(e);return null!==s&&i.push(s),i},randomNum=function(t,e){e=Math.random()*(e-t)+t;return Math.floor(e)},searchElem=function(t,e){for(var n,i=0,s=e.length;i<s;i++)if(`[${(n=e[i]).name}]`===t&&null!=n)return n.number},toPDF=function(t,e){var n;return t=(t+="<style>body{font-size:1.3em;}a{color:black;font-weight:bold;text-decoration:none;pointer-events:none;}</style>").replace(/href=\"(.*?)\"/gm,""),(n=document.createElement("div")).id="content",n.innerHTML=t,t={filename:e.title+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2},margin:.7,enableLinks:!0,pagebreak:{mode:"avoid-all"},jsPDF:{unit:"in",format:"letter",orientation:"portrait"}},html2pdf().set(t).from(n).save()},toHTML=function(t,e){return t=`<!DOCTYPE html>
	<html lang="${e.lang}">
	<head>
    			<meta charset="UTF-8">
    			<meta http-equiv="X-UA-Compatible" content="IE=edge">
    			<meta name="viewport" content="width=device-width, initial-scale=1.0">
   				<title>${e.title}</title>
	</head>
	<body>
		${t}
	</body>
</html>`},toEPUB=async function(t,e){var n=t.split("\n");return n.splice(0,1),n.splice(0,1),t=n.join("\n"),(n=new jEpub).init({i18n:e.lang,title:e.title,author:e.author,publisher:e.publisher,description:e.description,tags:e.tags}),n.date(new Date),n.add("Librojuego",t),t=await n.generate("blob"),n=e.title+".epub",(e=document.createElement("a")).download=n,e.innerHTML="Download File",null!=window.webkitURL?e.href=window.webkitURL.createObjectURL(t):(e.href=window.URL.createObjectURL(t),e.onclick=destroyClickedElement,e.style.display="none",document.body.appendChild(e)),e.click()},toDOCX=function(t,e){t=htmlDocx.asBlob(t);return saveAs(t,e.title+".docx")},saveTextFile=function(t,e,n){e=e.title+"."+n,n=new Blob([t],{type:"text/plain"}),t=document.createElement("a");return t.download=e,t.innerHTML="Download File",null!=window.webkitURL?t.href=window.webkitURL.createObjectURL(n):(t.href=window.URL.createObjectURL(n),t.onclick=destroyClickedElement,t.style.display="none",document.body.appendChild(t)),t.click()},Talos=class{constructor(t,e){this.storySrc=t,this.settings=e,this.converter=new markdownit({html:!0}),this.container=$("#talos-play"),this.info=$("#talos-info"),this.keywords={},this.history={},this.yaml=null,this.src="",this.currentSection=null,this.story={}}play(){return console.log("test")}compile(N=""){var t,e,n,i,s,l,o,a,F,r,h,m,c,u,d,p,f,B,P,z,S,H,_,q,V,X,Y,J,W,Z,G,K,Q,b,tt,et,y,g,nt,it,k,x,$,w,st,R,E,L,v,lt,ot,at,rt,ht,mt,ct,ut,dt,pt,T,O,A,U,D,C,j,I,M;for(this.info.html(this.info.html()+"<span><i>[0/8] Estableciendo configuración inicial...</i></span></br>"),this.story=JSON.parse(JSON.stringify(this.storySrc)),this.info.html(""),this.yaml=null,this.src="",this.info.html(this.info.html()+"<span><i>[1/8] Procesando cabecera del documento...</i></span></br>"),this.yaml=jsyaml.load(this.story.yml),null!=this.yaml.title?this.src+=`<h1 style='font-size: 2.5em; text-align: center'>${this.yaml.title}</h1>

`:this.yaml.title="Sin Título",null!=this.yaml.author?this.src+=`<h1 style='font-style: italic; text-align: center;margin-bottom: 2em;'>${this.yaml.author}</h1>

`:this.yaml.author="Anónimo",null==this.yaml.lang&&(this.yaml.lang="es"),null==this.yaml.publisher&&(this.yaml.publisher=""),null==this.yaml.description&&(this.yaml.description=""),null==this.yaml.tags&&(this.yaml.tags=[]),null==this.yaml.turn_to?this.yaml.turn_to="":this.yaml.turn_to=` ${this.yaml.turn_to} `,this.info.html(this.info.html()+"<span><i>[2/8] Recolectando secciones fijas...</i></span></br>"),a=[],n=null,h=m=0,B=(lt=this.story.blocks).length;h<B;h++)"fixed"===(s=lt[h]).type&&(n={blockIndex:m,number:parseInt(s.name)},a.push(n)),m++;for(d=m=0,P=(ot=this.story.blocks).length;d<P;d++){for(p=u=0,X=(at=(s=ot[d]).lines).length;p<X;p++)null!=(b=at[p]).match(regexLib.div)&&(this.story.blocks[m].lines[u]=""),u++;m++}for(this.info.html(this.info.html()+"<span><i>[3/8] Asignando números aleatorios a las secciones no numeradas...</i></span></br>"),y=[],nt=[],n=null,w=[],f=k=x=i=c=m=0,Y=(rt=this.story.blocks).length;f<Y;f++){if("fixed"===(s=rt[f]).type){for(g=0,J=y.length;g<J;g++)if((F=y[g])===s.name)return this.info.html(`${this.info.html()}<span style='color: darkred;'>ERROR: El nombre de la sección <b>${s.name}</b> se repite en otra sección.</span><br/>`),this.info.text();if(y.push(s.name),a[c].number===parseInt(s.name)){if(null!=a[c+1]){if(x=a[c].number,k=a[c+1].number,T=x+(i=a[c+1].blockIndex-m-1)+1,k<x)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El numero de la sección <b>${x}</b> es mayor que el de la sección siguiente: <b>${k}</b>.</span><br/>`),this.info.text();if(k<T)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: La cantidad de secciones anteriores a <b>${k}</b> le superan por ${T-k}.</span><br/>`),this.info.text();T<k&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: La cantidad de secciones anteriores a <b>${k}</b> son insuficientes, faltan ${k-T}.</span><br/>`)}else i=this.story.blocks.length-a[c].number,k=this.story.blocks.length;for(e=x+1,w=[];e<=x+i;)w.push(e),e++}c++}else if("normal"===s.type){if(F===s.name)return this.info.html(`${this.info.html()}<span style='color: darkred;'>ERROR: El nombre de la sección <b>${s.name}</b> se repite en otra sección.</span><br/>`),this.info.text();y.push(s.name),T=randomNum(0,w.length),n={name:s.name,number:w[T],index:m},this.story.blocks[m].name=String(w[T]),w.splice(T,1),nt.push(n)}m++}for(this.info.html(this.info.html()+"<span><i>[4/8] Reasignando enlaces a las secciones numeradas...</i></span></br>"),tt={},$=m=0,W=(ht=this.story.blocks).length;$<W;$++){for(R=u=0,Z=(mt=(s=ht[$]).lines).length;R<Z;R++){if(null!=(it=(b=mt[R]).match(regexLib.link)))for(L=0,G=it.length;L<G;L++){for(et=!(tt[""+(t=(t=(A=it[L]).replace("[","")).replace("]",""))]=!0),v=0,K=y.length;v<K;v++)(F=y[v])===t&&(et=!0);et||this.info.html(`${this.info.html()}<span style='color: darkgoldenrod;'>ADVERTENCIA: La sección <b>${t}</b>  a la que apunta <b>${s.name}</b> no existe.</span><br/>`),st=isNaN(t)?searchElem(A,nt):t,b=b.replaceAll(A,this.yaml.turn_to+`[${st}](#${st})`)}this.story.blocks[m].lines[u]=b,u++}m++}for(this.info.html(this.info.html()+"<span><i>[5/8] Examinando si hay secciones huérfanas...</i></span></br>"),E=[],O=0,Q=y.length;O<Q;O++)tt[A=y[O]]||E.push(A);if(E)for(U=0,z=E.length;U<z;U++)"1"!==(A=E[U])&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: Ningún enlace apunta a la sección <b>${A}</b>.</span><br/>`);for(this.info.html(this.info.html()+"<span><i>[6/8] Organizando las secciones en orden secuencial...</i></span></br>"),o=[],D=m=0,S=(ct=this.story.blocks).length;D<S;D++){if("ignored"===(s=ct[D]).type)for(this.src+=`<h1 style='text-align: center;'>${s.name}</h1>

`,C=0,H=(ut=s.lines).length;C<H;C++)b=ut[C],this.src+=b+`
`;else if("fixed"===s.type){if(null!=o)for(o.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),j=0,_=o.length;j<_;j++)for(l=o[j],this.src+=`<h1 id='${l.name}' name='${l.name}' style='text-align: center;'>${l.name}</h1>

`,I=0,q=(dt=l.lines).length;I<q;I++)b=dt[I],this.src+=b+`
`;for(o=[],this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;'>${s.name}</h1>

`,M=0,V=(pt=s.lines).length;M<V;M++)b=pt[M],this.src+=b+`
`}else"normal"===s.type&&o.push(s);m++}return this.info.html(this.info.html()+"<span><i>[7/8] Renderizando documento...</i></span></br>"),r=this.converter.render(this.src),"preview"===N?(this.info.html(this.info.html()+"<span><i>[8/8] Visualizando documento en vista previa...</i></span></br>"),r):"review"===N?(this.info.html(this.info.html()+"<span><i>[8/8] Compilación exitosa...</i></span></br>"),r):(this.info.html(`${this.info.html()}<span><i>[8/8] Exportando el documento a formato <b>${this.yaml.output}</b>...</i></span></br>`),null!=this.yaml.output?"pdf"===this.yaml.output?toPDF(r,this.yaml):"html"===this.yaml.output?saveTextFile(toHTML(r,this.yaml),this.yaml,"html"):"epub"===this.yaml.output?toEPUB(r,this.yaml):"docx"===this.yaml.output?toDOCX(r,this.yaml):this.info.html(`${this.info.html}<span style='color: darkred;'>ERROR: El formato de salida <b>*.${this.yaml.output}</b> no está soportado por Talos. Pruebe con: html, epub, docx y pdf.</span></br>`):saveTextFile(toHTML(r,this.yaml),this.yaml,"html"))}};