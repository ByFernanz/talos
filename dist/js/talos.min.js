var test=null,regexLib={normal:/^[a-z][a-z_0-9]*\s{0,1}(.*)$/m,fixed:/^[0-9]+\s{0,1}(.*)$/m,ignored:/^[A-Z].*$/m,link:/\[([^\[\]]+)\](?!\(|\:|{)/gm,div:/^(\:{3,}).*/m},parseText=function(t){t=t.split(/\n|\r\n/);return{yml:extractYAML(t),blocks:extractBlocks(t)}},extractYAML=function(t){for(var e,n,i,l=[],s="",a=!0,o=!1,r=0,h=t.length;r<h;r++)i=t[r],a&&!o?i.startsWith("---")?o=!(a=!1):a=!1:!a&&o&&(i.startsWith("---")?o=a=!1:l.push(i));for(e=0,n=l.length;e<n;e++)s+=l[e]+"\n";return s},getBlockType=function(t){return null!=t.match(regexLib.normal)?"normal":null!=t.match(regexLib.fixed)?"fixed":null!=t.match(regexLib.ignored)?"ignored":void 0},extractBlocks=function(t){for(var e,n,i=[],l=null,s=0,a=t.length;s<a;s++)null!=(n=(e=t[s]).match(/^(#{1})\s+([^#].*)$/))?(null!==l&&i.push(l),l={type:getBlockType(n[2]),name:n[2],lines:[]}):null!==l&&l.lines.push(e);return null!==l&&i.push(l),i},randomNum=function(t,e){e=Math.random()*(e-t)+t;return Math.floor(e)},searchElem=function(t,e){for(var n,i=0,l=e.length;i<l;i++)if(`[${(n=e[i]).name}]`===t&&null!=n)return n.number},toPDF=function(t,e){var n;return t=(t+="<style>body{font-size:1.3em;}a{color:black;font-weight:bold;text-decoration:none;pointer-events:none;}</style>").replace(/href=\"(.*?)\"/gm,""),(n=document.createElement("div")).id="content",n.innerHTML=t,t={filename:e.title+".pdf",image:{type:"jpeg",quality:.98},html2canvas:{scale:2},margin:.7,enableLinks:!0,pagebreak:{mode:"avoid-all"},jsPDF:{unit:"in",format:"letter",orientation:"portrait"}},html2pdf().set(t).from(n).save()},toHTML=function(t,e){return t=`<!DOCTYPE html>
	<html lang="${e.lang}">
	<head>
    			<meta charset="UTF-8">
    			<meta http-equiv="X-UA-Compatible" content="IE=edge">
    			<meta name="viewport" content="width=device-width, initial-scale=1.0">
   				<title>${e.title}</title>
	</head>
	<body>
		${t}
	</body>
</html>`},toEPUB=async function(t,e){var n=t.split("\n");return n.splice(0,1),n.splice(0,1),t=n.join("\n"),(n=new jEpub).init({i18n:e.lang,title:e.title,author:e.author,publisher:e.publisher,description:e.description,tags:e.tags}),n.date(new Date),n.add("Librojuego",t),t=await n.generate("blob"),n=e.title+".epub",(e=document.createElement("a")).download=n,e.innerHTML="Download File",null!=window.webkitURL?e.href=window.webkitURL.createObjectURL(t):(e.href=window.URL.createObjectURL(t),e.onclick=destroyClickedElement,e.style.display="none",document.body.appendChild(e)),e.click()},toDOCX=function(t,e){t=htmlDocx.asBlob(t);return saveAs(t,e.title+".docx")},saveTextFile=function(t,e,n){e=e.title+"."+n,n=new Blob([t],{type:"text/plain"}),t=document.createElement("a");return t.download=e,t.innerHTML="Download File",null!=window.webkitURL?t.href=window.webkitURL.createObjectURL(n):(t.href=window.URL.createObjectURL(n),t.onclick=destroyClickedElement,t.style.display="none",document.body.appendChild(t)),t.click()},Talos=class{constructor(t,e,n){this.storySrc=t,this.info=e,this.settings=n,this.converter=new markdownit({html:!0}),this.yaml=null,this.src="",this.story={}}compile(N=""){var t,e,F,n,i,l,s,a,o,r,h,m,c,d,u,p,f,b,y,g,$,P,B,z,_,H,S,q,V,X,Y,J,W,Z,G,K,Q,tt,et,nt,k,it,lt,x,st,R,at,ot,E,w,L,v,rt,T,O,A,U,ht,mt,ct,dt,ut,pt,ft,bt,yt,gt,$t,D,C,I,j,M,kt,xt,Rt,Et,wt;for(this.info.html(""),this.info.html(this.info.html()+"<span><i>[0/8] Estableciendo configuración inicial...</i></span></br>"),this.story=JSON.parse(JSON.stringify(this.storySrc)),this.yaml=null,this.src="",this.info.html(this.info.html()+"<span><i>[1/8] Procesando cabecera del documento...</i></span></br>"),this.yaml=jsyaml.load(this.story.yml),null!=this.yaml.title?this.src+=`<h1 style='font-size: 2.5em; text-align: center; line-height: 1.2em;'>${this.yaml.title}</h1>

`:this.yaml.title="Sin Título",null!=this.yaml.author?this.src+=`<h1 style='font-style: italic; text-align: center;margin-bottom: 2em;line-height: 1.2em;'>${this.yaml.author}</h1>

`:this.yaml.author="Anónimo",null==this.yaml.lang&&(this.yaml.lang="es"),null==this.yaml.publisher&&(this.yaml.publisher=""),null==this.yaml.description&&(this.yaml.description=""),null==this.yaml.output&&(this.yaml.output="html"),null==this.yaml.tags&&(this.yaml.tags=[]),null==this.yaml.turn_to?this.yaml.turn_to="":this.yaml.turn_to=` ${this.yaml.turn_to} `,F=0,this.info.html(this.info.html()+"<span><i>[2/8] Recolectando secciones fijas...</i></span></br>"),o=[],n=null,m=d=0,P=(ht=this.story.blocks).length;m<P;m++)"fixed"===(l=ht[m]).type&&(n={blockIndex:d,number:parseInt(l.name)},o.push(n)),"normal"===l.type&&F++,d++;for(b=d=0,B=(mt=this.story.blocks).length;b<B;b++){for(g=f=0,W=(dt=(l=mt[b]).lines).length;g<W;g++)null!=(k=dt[g]).match(regexLib.div)&&(this.story.blocks[d].lines[f]=""),f++;d++}for(this.info.html(this.info.html()+"<span><i>[3/8] Asignando números aleatorios a las secciones no numeradas...</i></span></br>"),x=[],at=[],n=null,v=[],$=E=w=i=p=d=0,Z=(ut=this.story.blocks).length;$<Z;$++){if("fixed"===(l=ut[$]).type){if(x.push(l.name),o[p].number===parseInt(l.name)){if(null!=o[p+1]){if(w=o[p].number,E=o[p+1].number,D=w+(i=o[p+1].blockIndex-d-1)+1,E<w)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El numero de la sección <b>${w}</b> es mayor que el de la sección siguiente: <b>${E}</b>.</span><br/>`),`<span style='color: darkred;'>ERROR: El numero de la sección <b>${w}</b> es mayor que el de la sección siguiente: <b>${E}</b>.</span><br/>`;if(E<D)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: La cantidad de secciones anteriores a <b>${E}</b> le superan por ${D-E}.</span><br/>`),`<span style='color: darkred;'>ERROR: La cantidad de secciones anteriores a <b>${E}</b> le superan por ${D-E}.</span><br/>`;D<E&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: La cantidad de secciones anteriores a <b>${E}</b> son insuficientes, faltan ${E-D}.</span><br/>`)}else E=i=F,w=1;for(e=w+1,v=[];e<=w+i;)v.push(e),e++;console.log(v)}p++}else"normal"===l.type&&(x.push(l.name),D=randomNum(0,v.length),n={name:l.name,number:v[D],index:d},this.story.blocks[d].name=String(v[D]),v.splice(D,1),at.push(n));d++}for(R=u=d=0,G=(st=x).length;R<G;R++){for(r=x[R],L=u=0,K=st.length;L<K;L++){if(r===st[L]&&d!==u)return this.info.html(this.info.html()+`<span style='color: darkred;'>ERROR: El nombre de la sección <b>${r}</b> se repite en otra sección.</span><br/>`),`<span style='color: darkred;'>ERROR: El nombre de la sección <b>${r}</b> se repite en otra sección.</span><br/>`;u++}d++}for(this.info.html(this.info.html()+"<span><i>[4/8] Reasignando enlaces a las secciones numeradas...</i></span></br>"),it={},T=d=0,Q=(pt=this.story.blocks).length;T<Q;T++){for(A=f=0,tt=(ft=(l=pt[T]).lines).length;A<tt;A++){if(null!=(ot=(k=ft[A]).match(regexLib.link)))for(U=0,et=ot.length;U<et;U++){for(lt=!(it[""+(t=(t=(I=ot[U]).replace("[","")).replace("]",""))]=!0),C=0,nt=x.length;C<nt;C++)x[C]===t&&(lt=!0);lt||this.info.html(`${this.info.html()}<span style='color: darkgoldenrod;'>ADVERTENCIA: La sección <b>${t}</b>  a la que apunta <b>${l.name}</b> no existe.</span><br/>`),k=null!=(rt=isNaN(t)?searchElem(I,at):t)?k.replaceAll(I,this.yaml.turn_to+`[${rt}](#${rt})`):k.replaceAll(I,this.yaml.turn_to+"[sección no definida](#no-definida)")}this.story.blocks[d].lines[f]=k,f++}d++}for(this.info.html(this.info.html()+"<span><i>[5/8] Examinando si hay secciones huérfanas...</i></span></br>"),O=[],j=0,z=x.length;j<z;j++)it[I=x[j]]||O.push(I);if(O)for(M=0,_=O.length;M<_;M++)"1"!==(I=O[M])&&this.info.html(this.info.html()+`<span style='color: darkgoldenrod;'>ADVERTENCIA: Ningún enlace apunta a la sección <b>${I}</b>.</span><br/>`);for(this.info.html(this.info.html()+"<span><i>[6/8] Organizando las secciones en orden secuencial...</i></span></br>"),a=[],kt=d=0,H=(bt=this.story.blocks).length;kt<H;kt++){if("ignored"===(l=bt[kt]).type)for(this.src+=`<h1 style='text-align: center;line-height: 1.2em;'>${l.name}</h1>

`,xt=0,S=(yt=l.lines).length;xt<S;xt++)k=yt[xt],this.src+=k+`
`;else if("fixed"===l.type){if(a)for(a.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),Rt=0,q=a.length;Rt<q;Rt++)for(s=a[Rt],this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;line-height: 1.2em;'>${s.name}</h1>

`,Et=0,V=(gt=s.lines).length;Et<V;Et++)k=gt[Et],this.src+=k+`
`;for(a=[],this.src+=`<h1 id='${l.name}' name='${l.name}' style='text-align: center;line-height: 1.2em;'>${l.name}</h1>

`,wt=0,X=($t=l.lines).length;wt<X;wt++)k=$t[wt],this.src+=k+`
`}else"normal"===l.type&&a.push(l);d++}if(a)for(a.sort(function(t,e){return parseInt(t.name)>parseInt(e.name)?1:-1}),c=0,Y=a.length;c<Y;c++)for(s=a[c],this.src+=`<h1 id='${s.name}' name='${s.name}' style='text-align: center;line-height: 1.2em;'>${s.name}</h1>

`,y=0,J=(ct=s.lines).length;y<J;y++)k=ct[y],this.src+=k+`
`;return a=[],this.info.html(this.info.html()+"<span><i>[7/8] Renderizando documento...</i></span></br>"),h=this.converter.render(this.src),"preview"===N?(this.info.html(this.info.html()+"<span><i>[8/8] Visualizando documento en vista previa...</i></span></br>"),h):"review"===N?(this.info.html(this.info.html()+"<span><i>[8/8] Compilación exitosa...</i></span></br>"),h):(this.info.html(`${this.info.html()}<span><i>[8/8] Exportando el documento a formato <b>${this.yaml.output}</b>...</i></span></br>`),null!=this.yaml.output?"pdf"===this.yaml.output?toPDF(h,this.yaml):"html"===this.yaml.output?saveTextFile(toHTML(h,this.yaml),this.yaml,"html"):"epub"===this.yaml.output?toEPUB(h,this.yaml):"docx"===this.yaml.output?toDOCX(h,this.yaml):(this.info.html(`${this.info.html}<span style='color: darkred;'>ERROR: El formato de salida <b>*.${this.yaml.output}</b> no está soportado por Talos. Pruebe con: html, epub, docx y pdf.</span></br>`),`<span style='color: darkred;'>ERROR: El formato de salida <b>*.${this.yaml.output}</b> no está soportado por Talos. Pruebe con: html, epub, docx y pdf.</span></br>`):saveTextFile(toHTML(h,this.yaml),this.yaml,"html"))}};